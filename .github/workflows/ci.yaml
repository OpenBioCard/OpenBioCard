name: Build (PR)

on:
  pull_request_target:
    branches:
      - main
      - master

permissions:
  pull-requests: write
  issues: write
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          persist-credentials: false

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # Run build and capture logs
      - name: Build
        id: build
        shell: bash
        run: |
          set -eo pipefail
          pnpm build --bail 2>&1 | tee build.log

      # Comment or update existing PR comment with status
      - name: Comment on PR (update if exists)
        if: always() && (steps.build.outcome == 'success' || steps.build.outcome == 'failure')
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const isSuccess = '${{ steps.build.outcome }}' === 'success';
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            
            let body = '';
            if (isSuccess) {
              body = `‚úÖ **pnpm build successful**\n\nÊâÄÊúâÊ®°ÂùóÊûÑÂª∫ÈÄöËøáÔºÅ\n\nüîó **Workflow run:**\n${runUrl}`;
            } else {
              if (!fs.existsSync('build.log')) {
                body = `‚ùå **pnpm build failed**\n\nÊûÑÂª∫ËøáÁ®ã‰∏≠ÂèëÁîüÈîôËØØÔºå‰ΩÜÊú™ÁîüÊàê build.log„ÄÇ\n\nüîó **Workflow run:**\n${runUrl}`;
              } else {
                const raw = fs.readFileSync('build.log', 'utf8');
                const lines = raw.split('\n');
                const noise = [
                  /^Progress:/i, /^Packages:/i, /^Lockfile/i, /^Already up to date/i,
                  /^\s*cache/i, /^\s*added\s+\d+/i, /^\s*resolved\s+\d+/i,
                  /^\s*downloaded\s+\d+/i, /^\s*INFO/i, /^\s*WARN/i, /^\s*Note:/i,
                  /^\s*Done in/i
                ];
                const isNoise = line => noise.some(r => r.test(line));

                const groups = {
                  TypeScript: [], Vite: [], ESLint: [], Turbo: [], Other: [],
                };

                for (const line of lines) {
                  const trimmed = line.trim();
                  if (!trimmed || isNoise(line)) continue;
                  if (/TS\d+|Type error|TypeScript/i.test(line)) groups.TypeScript.push(line);
                  else if (/vite/i.test(line)) groups.Vite.push(line);
                  else if (/eslint/i.test(line)) groups.ESLint.push(line);
                  else if (/turbo|turborepo/i.test(line)) groups.Turbo.push(line);
                  else groups.Other.push(line);
                }

                let content = '';
                for (const [name, logs] of Object.entries(groups)) {
                  if (!logs.length) continue;
                  let block = logs.join('\n');
                  const MAX = 12000;
                  if (block.length > MAX) block = '...log truncated...\n' + block.slice(-MAX);
                  content += `\n### ${name}\n\n\`\`\`\n${block}\n\`\`\`\n`;
                }

                if (!content.trim()) {
                  const lastLines = lines.filter(l => l.trim()).slice(-20).join('\n');
                  content = `\n### Build Log (Last 20 lines)\n\n\`\`\`\n${lastLines}\n\`\`\`\n`;
                }

                body = `‚ö†Ô∏è **pnpm build reported errors (non-blocking)**\n\nüîó **Workflow run:**\n${runUrl}\n\n<details>\n<summary>Error details (filtered & grouped)</summary>\n${content}\n</details>`;
              }
            }

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const existing = comments.find(c =>
              (c.user.type === 'Bot' || c.user.login.includes('github-actions')) &&
              (c.body.includes('pnpm build reported errors') || c.body.includes('pnpm build successful') || c.body.includes('pnpm build failed'))
            );

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body
              });
            }
